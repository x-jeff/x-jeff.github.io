---
layout:     post
title:      ã€OpenCVåŸºç¡€ã€‘ç¬¬äºŒåäº”è¯¾ï¼šæ¨¡æ¿åŒ¹é…
subtitle:   æ¨¡æ¿åŒ¹é…ï¼Œcv::matchTemplate
date:       2021-10-21
author:     x-jeff
header-img: blogimg/20211021.jpg
catalog: true
tags:
    - OpenCV Series
---
>æœ¬æ–‡ä¸ºåŸåˆ›æ–‡ç« ï¼Œæœªç»æœ¬äººå…è®¸ï¼Œç¦æ­¢è½¬è½½ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚

# 1.æ¨¡æ¿åŒ¹é…

æ¨¡æ¿åŒ¹é…å°±æ˜¯åœ¨æ•´ä¸ªå›¾åƒåŒºåŸŸå‘ç°ä¸ç»™å®šå­å›¾åƒåŒ¹é…çš„å°å—åŒºåŸŸã€‚

![](https://github.com/x-jeff/BlogImage/raw/master/OpenCVSeries/Lesson25/25x1.png)

æ¨¡æ¿å›¾åƒåœ¨å¾…æ£€æµ‹çš„å›¾åƒä¸Šï¼Œä»å·¦åˆ°å³ï¼Œä»ä¸Šåˆ°ä¸‹è¿›è¡Œéå†ï¼Œå¹¶è®¡ç®—æ¨¡æ¿ä¸å¾…æ£€æµ‹å›¾åƒé‡å éƒ¨åˆ†çš„åŒ¹é…åº¦ã€‚

![](https://github.com/x-jeff/BlogImage/raw/master/OpenCVSeries/Lesson25/25x2.png)

OpenCVæä¾›äº†å…­ç§è®¡ç®—æ¨¡æ¿åŒ¹é…ç¨‹åº¦çš„æ–¹å¼ï¼š

ğŸ‘‰`TM_SQDIFF=0`ï¼ˆå€¼è¶Šå°ï¼ŒåŒ¹é…åº¦è¶Šé«˜ï¼‰ï¼š

$$R(x,y)= \sum _{x',y'} (T(x',y')-I(x+x',y+y'))^2$$

$T$ä¸ºæ¨¡æ¿å›¾åƒï¼Œ$I$ä¸ºå¾…æ£€æµ‹å›¾åƒï¼Œ$x'=[0,...,w-1];y'=[0,...,h-1]$ï¼Œå…¶ä¸­ï¼Œ$w,h$ä¸ºæ¨¡æ¿çš„å®½å’Œé«˜ï¼ˆä¸‹åŒï¼‰ã€‚

with maskï¼š

$$R(x,y)= \sum _{x',y'} \left( (T(x',y')-I(x+x',y+y')) \cdot M(x',y') \right)^2$$

Mä¸ºmaskï¼ˆä¸‹åŒï¼‰ã€‚

ğŸ‘‰`TM_SQDIFF_NORMED=1`ï¼ˆ`TM_SQDIFF`çš„å½’ä¸€åŒ–ï¼‰ï¼š

$$R(x,y)= \frac{\sum_{x',y'} (T(x',y')-I(x+x',y+y'))^2}{\sqrt{\sum_{x',y'}T(x',y')^2 \cdot \sum_{x',y'} I(x+x',y+y')^2}}$$

with maskï¼š

$$R(x,y)= \frac{\sum _{x',y'} \left( (T(x',y')-I(x+x',y+y')) \cdot M(x',y') \right)^2}{\sqrt{\sum_{x',y'} \left( T(x',y') \cdot M(x',y') \right)^2 \cdot \sum_{x',y'} \left( I(x+x',y+y') \cdot M(x',y') \right)^2}}$$

ğŸ‘‰`TM_CCORR=2`ï¼ˆå€¼è¶Šå¤§ï¼ŒåŒ¹é…åº¦è¶Šé«˜ï¼‰ï¼š

$$R(x,y)= \sum _{x',y'} (T(x',y') \cdot I(x+x',y+y'))$$

with maskï¼š

$$R(x,y)= \sum _{x',y'} (T(x',y') \cdot I(x+x',y+y') \cdot M(x',y')^2)$$

ğŸ‘‰`TM_CCORR_NORMED=3`ï¼ˆ`TM_CCORR`çš„å½’ä¸€åŒ–ï¼‰ï¼š

$$R(x,y)= \frac{\sum_{x',y'} (T(x',y') \cdot I(x+x',y+y'))}{\sqrt{\sum_{x',y'}T(x',y')^2 \cdot \sum_{x',y'} I(x+x',y+y')^2}}$$

with maskï¼š

$$R(x,y)= \frac{\sum_{x',y'} (T(x',y') \cdot I(x+x',y+y') \cdot M(x',y')^2)}{\sqrt{\sum_{x',y'} \left( T(x',y') \cdot M(x',y') \right)^2 \cdot \sum_{x',y'} \left( I(x+x',y+y') \cdot M(x',y') \right)^2}}$$

ğŸ‘‰`TM_CCOEFF=4`ï¼ˆå€¼è¶Šå¤§ï¼ŒåŒ¹é…åº¦è¶Šé«˜ï¼‰ï¼š

$$R(x,y)= \sum _{x',y'} (T'(x',y') \cdot I'(x+x',y+y'))$$

å…¶ä¸­ï¼š

$$T'(x',y')=T(x',y') - 1/(w \cdot h) \cdot \sum _{x'',y''} T(x'',y'')$$

$$I'(x+x',y+y')=I(x+x',y+y') - 1/(w \cdot h)\cdot \sum _{x'',y''} I(x+x'',y+y'')$$

with maskï¼š

$$T'(x',y')=M(x',y') \cdot \left( T(x',y') - \frac{1}{\sum _{x'',y''} M(x'',y'')} \cdot \sum _{x'',y''} (T(x'',y'') \cdot M(x'',y'')) \right)$$

 $$I'(x+x',y+y')=M(x',y') \cdot \left( I(x+x',y+y') - \frac{1}{\sum _{x'',y''} M(x'',y'')} \cdot \sum _{x'',y''} (I(x+x'',y+y'') \cdot M(x'',y'')) \right)$$

ğŸ‘‰`TM_CCOEFF_NORMED=5`ï¼ˆ`TM_CCOEFF`çš„å½’ä¸€åŒ–ï¼‰ï¼š

$$R(x,y)= \frac{ \sum_{x',y'} (T'(x',y') \cdot I'(x+x',y+y')) }{\sqrt{\sum_{x',y'}T'(x',y')^2 \cdot \sum_{x',y'} I'(x+x',y+y')^2}}$$

# 2.ç›¸å…³API

```c++
void matchTemplate( 
	InputArray image, 
	InputArray templ,
	OutputArray result, 
	int method, 
	InputArray mask = noArray() 
);
```

å‚æ•°è§£é‡Šï¼š

1. `InputArray image`ï¼šå¾…æ£€æµ‹å›¾åƒã€‚å¿…é¡»ä¸º8ä½æˆ–32ä½æµ®ç‚¹å‹å›¾åƒã€‚
2. `InputArray templ`ï¼šæ¨¡æ¿å›¾åƒã€‚å¤§å°ä¸åº”è¶…è¿‡å¾…æ£€æµ‹å›¾åƒï¼Œå’Œå¾…æ£€æµ‹å›¾åƒç±»å‹ç›¸åŒã€‚
3. `OutputArray result`ï¼šåŒ¹é…çš„ç»“æœã€‚å¿…é¡»æ˜¯å•é€šé“32ä½æµ®ç‚¹å‹å›¾åƒã€‚å¦‚æœå¾…æ£€æµ‹å›¾åƒçš„å¤§å°ä¸º$W\times H$ï¼Œæ¨¡æ¿çš„å¤§å°ä¸º$w\times h$ï¼Œåˆ™resultçš„å¤§å°ä¸º$(W-w+1) \times (H-h+1)$ã€‚ä¾‹å¦‚æ¨¡æ¿åœ¨å¾…æ£€æµ‹å›¾åƒçš„å·¦ä¸Šè§’æ—¶ï¼Œè®¡ç®—å¾—åˆ°çš„ç›¸ä¼¼åº¦å€¼ä¼šå¡«åˆ°resultçš„(0,0)ä½ç½®ï¼Œå‰©ä½™çš„ä»¥æ­¤ç±»æ¨ï¼Œæ¨¡æ¿åœ¨å¾…æ£€æµ‹å›¾åƒçš„å³ä¸‹è§’æ—¶ï¼Œè®¡ç®—å¾—åˆ°çš„ç›¸ä¼¼åº¦å€¼ä¼šå¡«åˆ°resultçš„$((W-w+1) , (H-h+1))$ä½ç½®ã€‚
4. `int method`ï¼šæ¨¡æ¿åŒ¹é…ç¨‹åº¦çš„è®¡ç®—æ–¹å¼ã€‚è¯¦è§ç¬¬1éƒ¨åˆ†ã€‚
5. `InputArray mask`ï¼šå’Œæ¨¡æ¿å¤§å°ä¸€æ ·ã€‚é€šé“æ•°å¯ä»¥ä¸º1ï¼Œæˆ–è€…å’Œæ¨¡æ¿é€šé“æ•°ä¸€æ ·ã€‚maskå…¶å®å°±æ˜¯èµ·åˆ°å¯¹æ¨¡æ¿åŠ æƒçš„ä½œç”¨ã€‚

# 3.ä»£ç åœ°å€

1. [æ¨¡æ¿åŒ¹é…](https://github.com/x-jeff/OpenCV_Code_Demo/tree/master/Demo25)
