---
layout:     post
title:      ã€æ·±åº¦å­¦ä¹ åŸºç¡€ã€‘ç¬¬ä¸‰åå››è¯¾ï¼šYOLOç®—æ³•
subtitle:   YOLOç®—æ³•ï¼Œäº¤å¹¶æ¯”IoUï¼Œéæå¤§å€¼æŠ‘åˆ¶NMSï¼ŒAnchor Box
date:       2020-09-06
author:     x-jeff
header-img: blogimg/20200906.jpg
catalog: true
tags:
    - Deep Learning Series
---
>ã€æ·±åº¦å­¦ä¹ åŸºç¡€ã€‘ç³»åˆ—åšå®¢ä¸ºå­¦ä¹ Courseraä¸Šå´æ©è¾¾æ·±åº¦å­¦ä¹ è¯¾ç¨‹æ‰€åšçš„è¯¾ç¨‹ç¬”è®°ã€‚  
>æœ¬æ–‡ä¸ºåŸåˆ›æ–‡ç« ï¼Œæœªç»æœ¬äººå…è®¸ï¼Œç¦æ­¢è½¬è½½ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚

# 1.bounding boxçš„é¢„æµ‹

åœ¨ä¸Šç¯‡åšå®¢[ã€æ·±åº¦å­¦ä¹ åŸºç¡€ã€‘ç¬¬ä¸‰åä¸‰è¯¾ï¼šåŸºäºæ»‘åŠ¨çª—å£çš„ç›®æ ‡æ£€æµ‹ç®—æ³•](http://shichaoxin.com/2020/08/23/æ·±åº¦å­¦ä¹ åŸºç¡€-ç¬¬ä¸‰åä¸‰è¯¾-åŸºäºæ»‘åŠ¨çª—å£çš„ç›®æ ‡æ£€æµ‹ç®—æ³•/)ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†åŸºäºæ»‘åŠ¨çª—å£çš„ç›®æ ‡æ£€æµ‹ç®—æ³•ï¼Œä½†æ˜¯è¯¥ç®—æ³•å¹¶ä¸èƒ½è¾“å‡ºæœ€ç²¾å‡†çš„bounding boxã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å°è¯•çš„æ»‘åŠ¨çª—å£æ²¡æœ‰ä¸€ä¸ªèƒ½å®Œç¾åŒ¹é…ç›®æ ‡ä½ç½®ï¼Œå…¶æœ€åŒ¹é…çª—å£å¯èƒ½åœ¨ä¸‹å›¾è“æ¡†æ‰€ç¤ºä½ç½®ï¼š

![](https://github.com/x-jeff/BlogImage/raw/master/DeepLearningSeries/Lesson34/34x1.png)

è€Œè¯¥æ±½è½¦æœ€ä¼˜çš„bounding boxåˆ™å¦‚ä¸Šå›¾ä¸­çº¢æ¡†æ‰€ç¤ºï¼Œå¹¶ä¸”ä¸ä¸€å®šæ˜¯çŸ©å½¢ï¼Œå¯èƒ½æ˜¯ä¸ªæ¢¯å½¢ç­‰å½¢çŠ¶ã€‚é‚£ä¹ˆè¯¥å¦‚ä½•ç¡®å®šä¸€ä¸ªå‡†ç¡®çš„bounding boxå‘¢ï¼Ÿæ–¹æ³•ä¹‹ä¸€å°±æ˜¯ä½¿ç”¨**YOLOç®—æ³•**ã€‚YOLOç®—æ³•çš„å…¨ç§°æ˜¯ï¼š**You Only Look Once**ï¼ˆYOLOç®—æ³•ç¡®å®ä¹Ÿå¦‚åå­—çš„å«ä¹‰ä¸€æ ·ï¼Œè¿è¡Œé€Ÿåº¦éå¸¸å¿«ï¼Œå¯ä»¥è¾¾åˆ°å®æ—¶æ£€æµ‹ï¼‰ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸‹YOLOç®—æ³•æ˜¯å¦‚ä½•åšçš„ã€‚

å‡è®¾è¾“å…¥å›¾åƒä¸º$100\times 100 \times 3$ï¼Œæˆ‘ä»¬åœ¨å›¾åƒä¸Šæ”¾ç½®ä¸€ä¸ªç½‘æ ¼ï¼ˆgridï¼‰ï¼Œä¸ºäº†ç®€åŒ–ä»‹ç»ï¼Œè¿™é‡Œä½¿ç”¨$3\times 3$çš„ç½‘æ ¼ï¼ˆå®é™…åº”ç”¨æ—¶ä¼šä½¿ç”¨æ›´ç²¾ç»†çš„ç½‘æ ¼ï¼Œä¾‹å¦‚$19 \times 19$ï¼‰ï¼š

![](https://github.com/x-jeff/BlogImage/raw/master/DeepLearningSeries/Lesson34/34x2.png)

æˆ‘ä»¬å¯ä»¥è¿™æ ·å®šä¹‰è®­ç»ƒé›†çš„labelï¼Œå¯¹äºç½‘æ ¼ä¸­çš„æ¯ä¸€ä¸ªæ ¼å­ï¼ˆgrid cellï¼‰ï¼Œéƒ½æœ‰ï¼ˆå‡è®¾æ¯ä¸€ä¸ªæ ¼å­æœ€å¤šåªåŒ…å«ä¸€ä¸ªç›®æ ‡ï¼‰ï¼š

$$y=\begin{bmatrix} P_c \\ b_x \\ b_y \\ b_h \\ b_w \\ c_1 \\ c_2 \\ c_3 \end{bmatrix}$$

ç¬¦å·å«ä¹‰å’Œ[ã€æ·±åº¦å­¦ä¹ åŸºç¡€ã€‘ç¬¬ä¸‰åäºŒè¯¾ï¼šç›®æ ‡å®šä½å’Œç‰¹å¾ç‚¹æ£€æµ‹](http://shichaoxin.com/2020/08/21/æ·±åº¦å­¦ä¹ åŸºç¡€-ç¬¬ä¸‰åäºŒè¯¾-ç›®æ ‡å®šä½å’Œç‰¹å¾ç‚¹æ£€æµ‹/)ä¸­çš„ç›¸åŒï¼Œåœ¨æ­¤ä¸å†èµ˜è¿°ã€‚

éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œç›®æ ‡å½’å±äºå…¶**ä¸­å¿ƒç‚¹**æ‰€åœ¨çš„æ ¼å­ã€‚ä¾‹å¦‚åœ¨ä¸‹å›¾ä¸­ï¼Œç¬¬äºŒè¡Œçš„ç¬¬ä¸€å’Œç¬¬ä¸‰ä¸ªæ ¼å­å„åŒ…å«ä¸€ä¸ªç›®æ ‡ï¼Œè€Œç¬¬äºŒä¸ªæ ¼å­åˆ™è®¤ä¸ºæ— ç›®æ ‡å­˜åœ¨ï¼Œè™½ç„¶ç¬¬äºŒä¸ªæ ¼å­åŒæ—¶åŒ…å«äº†ä¸¤ä¸ªç›®æ ‡çš„ä¸€éƒ¨åˆ†ï¼š

![](https://github.com/x-jeff/BlogImage/raw/master/DeepLearningSeries/Lesson34/34x3.png)

æ¯ä¸ªæ ¼å­æˆ‘ä»¬éƒ½ä¼šå¾—åˆ°ä¸€ä¸ª8ç»´å‘é‡çš„è¾“å‡ºï¼Œå› æ­¤æ€»çš„è¾“å‡ºç»´åº¦ä¸º$3\times 3 \times 8$ï¼š

![](https://github.com/x-jeff/BlogImage/raw/master/DeepLearningSeries/Lesson34/34x4.png)

## 1.1.å¦‚ä½•å®šä¹‰bounding box

æœ¬éƒ¨åˆ†æ¥è¯´è¯´åœ¨YOLOç®—æ³•ä¸­å¦‚ä½•å®šä¹‰bounding boxï¼Œå³$b_x,b_y,b_h,b_w$çš„å€¼ã€‚

æˆ‘ä»¬çº¦å®šæ¯ä¸€ä¸ªæ ¼å­å·¦ä¸Šè§’çš„åæ ‡ä¸º$(0,0)$ï¼Œå³ä¸‹è§’çš„åæ ‡æ˜¯$(1,1)$ï¼š

![](https://github.com/x-jeff/BlogImage/raw/master/DeepLearningSeries/Lesson34/34x5.png)

å…¶ä¸­ï¼Œ$b_x,b_y$çš„èŒƒå›´åœ¨0åˆ°1å†…ï¼Œè€Œ$b_h,b_w$åˆ™æœ‰å¯èƒ½å¤§äº1ã€‚ä¾‹å¦‚åœ¨ä¸Šå›¾ä¸­ï¼Œæ±½è½¦çš„bounding boxå¯æ ‡è®°ä¸ºï¼š$b_x=0.4,b_y=0.3,b_h=0.5,b_w=0.9$ã€‚

# 2.äº¤å¹¶æ¯”

æˆ‘ä»¬è¯¥å¦‚ä½•åˆ¤æ–­ç›®æ ‡æ£€æµ‹ç®—æ³•ç»“æœçš„å¥½åå‘¢ï¼Ÿå¸¸ç”¨çš„ä¸€ä¸ªè¯„ä»·æŒ‡æ ‡å°±æ˜¯**äº¤å¹¶æ¯”ï¼ˆIntersection over Unionï¼Œç®€å†™ä¸ºIoUï¼‰**ã€‚

å‡è®¾çœŸå®çš„bounding boxå¦‚ä¸‹å›¾çº¢æ¡†æ‰€ç¤ºï¼Œè€Œç®—æ³•é¢„æµ‹å‡ºæ¥çš„bounding boxå¦‚ä¸‹å›¾ç´«æ¡†æ‰€ç¤ºï¼š

![](https://github.com/x-jeff/BlogImage/raw/master/DeepLearningSeries/Lesson34/34x6.png)

IoUå°±æ˜¯è®¡ç®—ä¸¤ä¸ªbounding boxçš„äº¤é›†å’Œå¹¶é›†ä¹‹æ¯”ï¼Œå³é»„è‰²åŒºåŸŸé¢ç§¯æ¯”ä¸Šç»¿è‰²åŒºåŸŸé¢ç§¯ï¼š

![](https://github.com/x-jeff/BlogImage/raw/master/DeepLearningSeries/Lesson34/34x7.png)

å½“$IoU\geqslant 0.5$æ—¶ï¼Œé€šå¸¸è®¤ä¸ºé¢„æµ‹ç»“æœå°±æ˜¯æ­£ç¡®çš„ã€‚å½“ç„¶ä¹Ÿå¯ä»¥é€‰å–å…¶ä»–é˜ˆå€¼ï¼Œæ¯”å¦‚0.6ã€0.7ç­‰ã€‚IoUçš„å€¼è¶Šé«˜ï¼Œé¢„æµ‹çš„bounding boxå°±è¶Šå‡†ç¡®ã€‚

# 3.éæå¤§å€¼æŠ‘åˆ¶

ç›®æ ‡æ£€æµ‹ä»»åŠ¡ä¸­å­˜åœ¨çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯ç®—æ³•å¯èƒ½å¯¹åŒä¸€ä¸ªå¯¹è±¡åšå‡ºå¤šæ¬¡æ£€æµ‹ï¼ˆå³æœ‰å¤šä¸ªæ ¼å­éƒ½è®¤ä¸ºç›®æ ‡å±äºè‡ªå·±ï¼‰ï¼š

![](https://github.com/x-jeff/BlogImage/raw/master/DeepLearningSeries/Lesson34/34x8.png)

å„ä¸ªbounding boxæœ‰ç€ä¸åŒçš„é¢„æµ‹æ¦‚ç‡ã€‚æ­¤æ—¶æˆ‘ä»¬ä¾¿å¯é‡‡ç”¨**éæå¤§å€¼æŠ‘åˆ¶ï¼ˆNon-Maximum Suppressionï¼Œç®€å†™ä¸ºNMSï¼‰**æ¥å¤„ç†è¿™äº›ç»“æœã€‚

>bounding boxçš„æ¦‚ç‡å¯ä»¥é€šè¿‡$P_c \times c_n$æ¥è®¡ç®—ï¼Œ$c_n$ä¸ºè¯¥ç±»åˆ«ç›®æ ‡å­˜åœ¨çš„æ¦‚ç‡ã€‚

æˆ‘ä»¬å…ˆä»¥ä¸Šå›¾ä¸­å³ä¾§çš„æ±½è½¦ä¸ºä¾‹ï¼Œä¿ç•™å…¶æœ€é«˜æ¦‚ç‡çš„bounding boxï¼Œåˆ é™¤ä¸è¯¥bounding boxæœ‰ç€è¾ƒé«˜IoUçš„å…¶ä»–bounding boxã€‚ç„¶åå¯¹å·¦ä¾§çš„æ±½è½¦è¿›è¡ŒåŒæ ·çš„å¤„ç†ã€‚è¿™æ ·å³å¯å¾—åˆ°ç»è¿‡NMSåçš„æœ€ç»ˆç»“æœï¼š

![](https://github.com/x-jeff/BlogImage/raw/master/DeepLearningSeries/Lesson34/34x9.png)

å½“å­˜åœ¨å¤šä¸ªä¸åŒç±»åˆ«çš„å¯¹è±¡æ—¶ï¼Œåˆ†åˆ«å¯¹æ¯ä¸ªå¯¹è±¡è¿›è¡ŒNMSã€‚

# 4.Anchor Box

ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬åªè®¨è®ºäº†æ¯ä¸ªæ ¼å­åªèƒ½æ£€æµ‹å‡ºä¸€ä¸ªå¯¹è±¡çš„æƒ…å†µã€‚é‚£ä¹ˆå¦‚ä½•è®©ä¸€ä¸ªæ ¼å­æ£€æµ‹å‡ºå¤šä¸ªå¯¹è±¡å‘¢ï¼Ÿè¿™æ—¶å°±éœ€è¦å¼•å…¥anchor boxäº†ã€‚

å‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹ä¸€å¼ å›¾ï¼ˆä¾æ—§ä½¿ç”¨$3 \times 3$çš„ç½‘æ ¼ï¼‰ï¼Œæ±½è½¦å’Œè¡Œäººçš„ä¸­ç‚¹ä½äºåŒä¸€ä¸ªæ ¼å­ä¸­ï¼š

![](https://github.com/x-jeff/BlogImage/raw/master/DeepLearningSeries/Lesson34/34x10.png)

å¦‚æœæˆ‘ä»¬è¿˜æŒ‰ç¬¬1éƒ¨åˆ†å®šä¹‰çš„labelï¼Œåˆ™æ— æ³•åŒæ—¶é¢„æµ‹ä¸¤ä¸ªå¯¹è±¡ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬äº‹å…ˆå®šä¹‰ä¸¤ä¸ªä¸åŒå½¢çŠ¶çš„anchor boxï¼š

![](https://github.com/x-jeff/BlogImage/raw/master/DeepLearningSeries/Lesson34/34x11.png)

âš ï¸anchor boxçš„ä¸ªæ•°ä¸æ¯ä¸ªæ ¼å­ä¸­å¯èƒ½å‡ºç°çš„æœ€å¤šç›®æ ‡æ•°é‡ç›¸åŒã€‚å®é™…é¡¹ç›®ä¸­ï¼Œä¼šç”¨æ›´å¤šçš„anchor boxã€‚

åŒæ—¶å°†labelå¤åˆ¶ä¸ºåŸæ¥çš„ä¸¤å€ï¼Œç¬¬ä¸€ç»„å‚æ•°ï¼ˆå‰å…«ä¸ªå‚æ•°ï¼‰å…³è”anchor box1ï¼Œç¬¬äºŒç»„å‚æ•°ï¼ˆåå…«ä¸ªå‚æ•°ï¼‰å…³è”anchor box2ï¼š

$$y=\begin{bmatrix} P_c \\ b_x \\ b_y \\ b_h \\ b_w \\ c_1 \\ c_2 \\ c_3 \\ P_c \\ b_x \\ b_y \\ b_h \\ b_w \\ c_1 \\ c_2 \\ c_3 \end{bmatrix}$$

å› ä¸ºè¡Œäººçš„å½¢çŠ¶æ›´ç±»ä¼¼äºanchor box1ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç”¨å‰å…«ä¸ªå‚æ•°è¡¨ç¤ºè¡Œäººã€‚åŒç†ï¼Œä½¿ç”¨åå…«ä¸ªå‚æ•°è¡¨ç¤ºæ±½è½¦ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªç›®æ ‡éƒ½ä¼šè¢«åˆ†é…ä¸€ä¸ªæ ¼å­å’Œanchor boxï¼ˆè¯¥anchor boxå’Œè¯¥ç›®æ ‡æœ‰ç€æœ€é«˜çš„IoUï¼‰ã€‚å› æ­¤ï¼Œç°åœ¨çš„è¾“å‡ºç»´åº¦ä¸º$3\times 3 \times 16$ï¼ˆæˆ–$3\times 3 \times 2 \times 8$ï¼‰ã€‚

é’ˆå¯¹ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼Œç®—æ³•å¯èƒ½ä¼šå¤„ç†ä¸å¥½ï¼š

1. anchor boxçš„ä¸ªæ•°å°äºæ¯ä¸ªæ ¼å­ä¸­å¯èƒ½å‡ºç°çš„æœ€å¤šç›®æ ‡æ•°é‡ã€‚æ¯”å¦‚é¢„å…ˆè®¾å®šäº†2ä¸ªanchor boxï¼Œä½†æ˜¯åŒä¸€ä¸ªæ ¼å­é‡Œå‡ºç°äº†3ä¸ªç›®æ ‡ã€‚
2. åŒä¸€ä¸ªæ ¼å­é‡Œçš„å¤šä¸ªç›®æ ‡è¢«åˆ†é…åˆ°åŒä¸€ä¸ªanchor boxã€‚

é‚£ä¹ˆè¯¥å¦‚ä½•é€‰æ‹©anchor boxå‘¢ï¼Ÿ

1. äººå·¥æŒ‡å®šã€‚
2. k-meansç®—æ³•ã€‚

# 5.YOLOç®—æ³•

è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å­¦ä¹ äº†YOLOç®—æ³•ä¸­æ‰€æœ‰é‡è¦çš„ç»„ä»¶ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä»æ›´å®è§‚çš„è§’åº¦ä»‹ç»ä¸‹YOLOç®—æ³•ã€‚

>YOLOç®—æ³•è®ºæ–‡ï¼šRedmon J , Divvala S , Girshick R , et al. You Only Look Once: Unified, Real-Time Object Detection[J]. 2015.

å‡è®¾è¾“å…¥ä¸º$448\times 448 \times 3$ï¼Œä½¿ç”¨$7\times 7$çš„ç½‘æ ¼ï¼š

![](https://github.com/x-jeff/BlogImage/raw/master/DeepLearningSeries/Lesson34/34x12.png)

è¾“å‡ºç»´åº¦ä¸º$7\times 7 \times 30$ï¼Œå‡è®¾æˆ‘ä»¬ä½¿ç”¨äº†ä¸¤ä¸ªanchor boxï¼Œä»»åŠ¡ä¸€å…±åŒ…å«20ä¸ªç±»åˆ«ï¼Œå³$5+5+20=30$ã€‚

ğŸ‘‰ç¬¬ä¸€ä¸ª5çš„å«ä¹‰ï¼ˆå³ç¬¬ä¸€ä¸ªanchor boxï¼‰ï¼š

![](https://github.com/x-jeff/BlogImage/raw/master/DeepLearningSeries/Lesson34/34x13.png)

ğŸ‘‰ç¬¬äºŒä¸ª5çš„å«ä¹‰ï¼ˆå³ç¬¬äºŒä¸ªanchor boxï¼‰ï¼š

![](https://github.com/x-jeff/BlogImage/raw/master/DeepLearningSeries/Lesson34/34x14.png)

ğŸ‘‰20çš„å«ä¹‰ï¼šå³ä¸€å…±æœ‰20ä¸ªç±»åˆ«ã€‚

åœ¨é¢„æµ‹é˜¶æ®µï¼Œæ¯ä¸ªgrid celléƒ½ä¼šé¢„æµ‹å‡ºæ¥ä¸¤ä¸ªbounding boxï¼ˆä¸ºæ–¹ä¾¿åšå›¾ï¼Œç®€åŒ–ä¸º$3\times 3$çš„gridï¼‰ï¼š

![](https://github.com/x-jeff/BlogImage/raw/master/DeepLearningSeries/Lesson34/34x15.png)

å»æ‰æ¦‚ç‡è¾ƒä½çš„bounding boxï¼š

![](https://github.com/x-jeff/BlogImage/raw/master/DeepLearningSeries/Lesson34/34x16.png)

å¯¹è¡Œäººå’Œæ±½è½¦è¿™ä¸¤ä¸ªç±»åˆ«åˆ†åˆ«æ‰§è¡ŒNMSï¼Œå¾—åˆ°æœ€ç»ˆçš„é¢„æµ‹ç»“æœï¼š

![](https://github.com/x-jeff/BlogImage/raw/master/DeepLearningSeries/Lesson34/34x17.png)