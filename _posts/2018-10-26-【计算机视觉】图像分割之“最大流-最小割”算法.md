---
layout:     post
title:      【计算机视觉】图像分割之“最大流-最小割”算法
subtitle:   计算机视觉，图像分割，最大流-最小割
date:       2018-10-26
author:     x-jeff
header-img: blogimg/20181026.jpg
catalog: true
tags:
    - Computer Vision
    - Image Segmentation
---  
>本文为原创文章，未经本人允许，禁止转载。转载请注明出处。

# 1.最大流问题
![](https://ws3.sinaimg.cn/large/006tNbRwly1fwn6hglmr2j30s00eqjsv.jpg)
如上图所示，如果起点为S点，终点为T点，有水流从S点流向到T点。图中黑色带箭头的直线为管道，水流只能按照箭头的方向前进，很明显，一个管道中不可能有两种方向的水流。“/”前的数字表示该条管道目前的流量，“/”后面的数字表示该条管道能承载的最大流量。水流从S点出发，集结到T点，S点出发的流和进入T点的流应该是相等的。**最大流问题**就是使流尽可能的大（在满足每条边容量的限制下）。

解决最大流问题通常有两种方法：

* **增广路径算法（augmenting paths）**
* **预流推进算法（push-relabel）**

本文主要介绍增广路径算法以及Graph Cut图割算法中所用的最大流-最小割算法。

# 2.增广路径算法
增广路径算法主要有：**Fold-Fulkerson算法**，**Edmonds-Karp算法**，**Dinic算法**等。其中，Fold-Fulkerson 是最基本的增广路径思想，也就是本博客要主要介绍的一种算法。
## 2.1.基本术语
通常将第1部分中的那张图称之为**容量网络**，对于容量网络中的一条边$(u,v)$，该边的上限称为**容量**，记作$c(u,v)$。实际**流量**记作$f(u,v)$。

c(u,v)-f(u,v)为剩余的容量，也成为**残量**。任意时刻，图中残量不为0的边组成的网络被称为**残余网络**，该网络上从s到t的路径被称为**增广路径**。

## 2.2.增广路径算法的主体思想
不断地从S点开始寻找增广路径，每次都对其进行增广，直到S点和T点不连通（因为残余网络的边的残量如果为0则从残余网络中删去这条边，所以最后会造成S点和T点不连通），也就是找不到增广路径为止（因为如果S点和T点连通，就意味着还存在增广路径）。当找不到增广路径的时候，当前的流量就是最大流。

接下来我们演示一下增广路径算法是怎么实现的：

STEP1：将容量网络转化成残余网络。
![](https://ws2.sinaimg.cn/large/006tNbRwly1fwnpnock0yj30re0ekq43.jpg)

STEP2：找到增广路径S$\rightarrow$A$\rightarrow$C$\rightarrow$T。
![](https://ws1.sinaimg.cn/large/006tNbRwly1fwnpy4wqzfj30q60dot9s.jpg)

STEP3：找到增广路径S$\rightarrow$B$\rightarrow$D$\rightarrow$E$\rightarrow$T。
![](https://ws1.sinaimg.cn/large/006tNbRwly1fwnqm03lulj30re0ekt9u.jpg)

至此，找不到其他增广路径了，最大流为3，最大流问题解决。

但是这里存在一个问题，如果我们在STEP2找到的是路径S$\rightarrow$B$\rightarrow$C$\rightarrow$T，残余网络见下图：
![](https://ws4.sinaimg.cn/large/006tNbRwly1fwnqunhkahj30r40eggmr.jpg)
然后下一步找到路径S$\rightarrow$A$\rightarrow$C$\rightarrow$T：
![](https://ws4.sinaimg.cn/large/006tNbRwly1fwnr6a8mymj30rk0e60tw.jpg)
此时，也满足残余网络S点和T点不连通，找不到其他增广路径等条件，但是最大流为2，这个结果明显不是最大流。这里，引入Fold-Fulkerson算法来解决这个问题。

## 2.3.Fold-Fulkerson算法
Fold-Fulkerson算法的核心思想就是引入反向边，正向边流了k个单位的流量，其反向边的残量增加k。

STEP1：引入反向边。
![](https://ws3.sinaimg.cn/large/006tNbRwly1fwnuyhpo3yj30r00egwg7.jpg)

STEP2：找到路径S$\rightarrow$B$\rightarrow$C$\rightarrow$T。
![](https://ws1.sinaimg.cn/large/006tNbRwly1fwnv0136w5j30rq0f6jt3.jpg)


STEP3：找到路径S$\rightarrow$A$\rightarrow$C$\rightarrow$T。
![](https://ws3.sinaimg.cn/large/006tNbRwly1fwnv6fo5i3j30rc0ee75y.jpg)

STEP4：正向边此时已经不存在增广路径，但是在引入反向边之后，出现了一条新的增广路径：S$\rightarrow$A$\rightarrow$C$\rightarrow$B$\rightarrow$D$\rightarrow$E$\rightarrow$T。
![](https://ws2.sinaimg.cn/large/006tNbRwly1fwnvb7l98wj30rm0esabp.jpg)

此时，彻底不存在增广路径，最大流为3，得到的结果与2.2部分正确结果一样。

## 2.4.搜索路径的方法
主要有两种搜索方法：**宽度优先搜索（BFS）**和**深度优先搜索（DFS）**。  
![](https://ws1.sinaimg.cn/large/006tNbRwly1fwperrf6ffj305w05i0t3.jpg)

* BFS（宽度优先搜索，广度优先搜索）：如果从1开始进行搜索的话，BFS的步骤就是，先搜索所有和1相连的，也就是2和5被找到了，然后再从2开始搜索和他相连的，也就是3被找到了，然后从5搜，也就是4被找到了，然后从3开始搜索，4被找到了，但是4之前已经被5找到了，所以忽略掉就行。然后3开始搜索，忽略4所以啥都没搜到，然后从4开始，6被找到了。
* DFS（深度优先搜索）：DFS的话从1开始，先找到其中一个相连的，2被找到了，然后直接开始从2开始搜索，3被找到了，然后从3开始搜索，4被找到了，然后从4开始搜索，5被找到了，然后从5开始搜索，忽略已经找到的所以啥都没找到。然后没路可走了，回到前面去再走另一条路，从4开始，6被找到了，然后又没路可走了，然后再回去前面4，然后没路了 ，回去前面3，然后一直这样。

Fold-Fulkerson算法使用的是DFS寻找路径。

# 3.最大流和最小割的关系
**最大流最小割定理**是指在一个网络流中，能够从源点（S点）到达汇点（T点）的最大流量等于如果从网络中移除就能够导致网络流中断的边的集合的最小容量和。即在任何网络中，最大流的值等于最小割的容量。

一个重要的相关定理：如果*f*是网络中的一个流，*CUT(S,T)*是任意一个割，那么*f*的值等于正向割边的流量与负向割边的流量之差。换种说法就是，任意一个流小于等于任意一个割。

最大流等于最小割的证明：  
设相等的流和割分别为$F_m$和$C_m$。则因为任意一个流小于等于任意一个割。$任意F≤F_m=C_m≤任意C$。证明完成。

我们根据之前的例子来验证一下：
![](https://ws1.sinaimg.cn/large/006tNbRwly1fwpffmjcnuj30s00e675t.jpg)
割的净流：$f=f(C,T)-f(B,C)+f(S,B)=2-0+1=3=max-flow$

# 4.Graph Cut中所用的最大流/最小割算法
先附上论文地址和OpenCV中的源码地址：

论文链接👉[An Experimental Comparison of Min-Cut/Max-Flow Algorithms for Energy Minimization in Vision.](http://www1.spms.ntu.edu.sg/~image/meeting/paper_2008103101.pdf)

OpenCV源码地址👉[maxflow](https://github.com/opencv/opencv/blob/e628fd7bce2b5d64c36b5bdc55a37c0ae78bc907/modules/imgproc/include/opencv2/imgproc/detail/gcgraph.hpp)

Graph Cut中所用的最大流/最小割算法是在Fold-Fulkerson算法基础上的改进，接下来让我们一探究竟吧。

>关于Graph Cut算法的详细介绍请见本人的另一篇博客：[【计算机视觉】图像分割之Graph Cut算法](http://shichaoxin.com/2018/10/21/计算机视觉-图像分割之Graph-Cut算法/)




# 5.参考资料：
1.[网络流初步:\<最大流\>--核心\(增广路算法\)](https://www.cnblogs.com/star-eternal/p/7616967.html)  

2.[算法录之BFS和DFS](https://www.cnblogs.com/whywhy/p/4888632.html)  

3.[最大流最小割定理（百度百科）](https://baike.baidu.com/item/最大流最小割定理/3851799?fr=aladdin)