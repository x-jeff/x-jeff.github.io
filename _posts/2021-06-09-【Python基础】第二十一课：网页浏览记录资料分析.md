---
layout:     post
title:      ã€PythonåŸºç¡€ã€‘ç¬¬äºŒåä¸€è¯¾ï¼šç½‘é¡µæµè§ˆè®°å½•èµ„æ–™åˆ†æ
subtitle:   parse_datesï¼Œpandas.uniqueï¼Œpandas.reset_indexï¼Œpandas.mergeï¼Œpandas.Series.dt.dateï¼Œpandas.concat
date:       2021-06-09
author:     x-jeff
header-img: blogimg/20210609.jpg
catalog: true
tags:
    - Python Series
---
>æœ¬æ–‡ä¸ºåŸåˆ›æ–‡ç« ï¼Œæœªç»æœ¬äººå…è®¸ï¼Œç¦æ­¢è½¬è½½ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚

# 1.è¯»å–ç”¨æˆ·è´­ä¹°è®°å½•

```python
import pandas as pd

m_cols = ["Time", "Action", "User", "Product", "Quantity", "Price"]
orders = pd.read_csv("purchase_order.tab", sep='\t', parse_dates={'Dates': [0]}, names=m_cols, encoding='utf-8')
```

`.tab`æ–‡ä»¶å…¶å®å°±æ˜¯ç”¨åˆ¶è¡¨ç¬¦åˆ†éš”çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè®¸å¤šç”µå­è¡¨æ ¼ç¨‹åºéƒ½å¯ä»¥å¯¼å…¥è¯¥ç±»å‹çš„æ–‡ä»¶ã€‚`sep='\t'`è¡¨ç¤ºåˆ†éš”æ ‡è¯†ä¸ºåˆ¶è¡¨ç¬¦ã€‚

`parse_dates={'Dates': [0]}`è¡¨ç¤ºå°†ç¬¬ä¸€åˆ—çš„æ—¶é—´å­—ç¬¦ä¸²è½¬æ¢æˆ[`datetime`æ ¼å¼](http://shichaoxin.com/2020/08/19/PythonåŸºç¡€-ç¬¬åäº”è¯¾-å¤„ç†æ—¶é—´æ ¼å¼èµ„æ–™/)ï¼Œå¹¶å°†è¯¥åˆ—å‘½åä¸ºâ€œDatesâ€ã€‚

`names`å¯ä»¥ä¸ºæ¯ä¸€åˆ—å‘½åã€‚

```python
print(orders.info())
print(orders.head())
```

![](https://github.com/x-jeff/BlogImage/raw/master/PythonSeries/Lesson21/21x1.png)

# 2.æ¢ç´¢ç”¨æˆ·è´­ä¹°è®°å½•

```python
#è·å–äº§å“P0006944501çš„å¹³å‡ä»·é’±
orders[orders["Product"] == "P0006944501"]["Price"].mean()
#è·å–äº§å“P0006944501çš„æœ€é«˜ä»·é’±
orders[orders["Product"] == "P0006944501"]["Price"].max()
#è·å–äº§å“P0006944501çš„æœ€ä½ä»·é’±
orders[orders["Product"] == "P0006944501"]["Price"].min()
#è·å–äº§å“P0006944501ä»·é’±çš„å™è¿°æ€§ç»Ÿè®¡
orders[orders["Product"] == "P0006944501"]["Price"].describe()
```

![](https://github.com/x-jeff/BlogImage/raw/master/PythonSeries/Lesson21/21x2.png)

```python
#ç»Ÿè®¡äº§å“ç±»å‹ï¼ˆå»é™¤é‡å¤ï¼‰
orders["Product"].unique()
len(orders["Product"].unique())
```

![](https://github.com/x-jeff/BlogImage/raw/master/PythonSeries/Lesson21/21x3.png)

ğŸ‘‰`unique`çš„ç”¨æ³•ï¼š

```python
obj=pd.Series(['c','a','d','a','a','b','b','c','c','c'])
obj.unique()#è¾“å‡ºï¼šarray(['c', 'a', 'd', 'b'], dtype=object)
```

åˆ©ç”¨åˆ†å±‚å¹³å‡æ•°ï¼ˆ[`groupby`](http://shichaoxin.com/2020/02/23/PythonåŸºç¡€-ç¬¬åä¸€è¯¾-å¤„ç†ç¼ºå¤±å€¼/#3groupbyå’Œtransform)ï¼‰æ±‚ä¸åŒäº§å“çš„å¹³å‡ä»·æ ¼ï¼š

```python
orders.groupby("Product")["Price"].mean().head()
```

![](https://github.com/x-jeff/BlogImage/raw/master/PythonSeries/Lesson21/21x4.png)

```python
#åœ¨ä¸Šè¿°åŸºç¡€ä¸Šï¼Œå¯¹ä»·æ ¼è¿›è¡Œé™åºæ’åˆ—
orders.groupby("Product")["Price"].mean().sort_values(ascending=False).head()
```

![](https://github.com/x-jeff/BlogImage/raw/master/PythonSeries/Lesson21/21x5.png)

```python
orders["Total_Price"] = orders["Quantity"] * orders["Price"]
print(orders.head())
```

![](https://github.com/x-jeff/BlogImage/raw/master/PythonSeries/Lesson21/21x6.png)

```python
orders.groupby('User')['Total_Price'].sum().sort_values(ascending=False).head()
```

![](https://github.com/x-jeff/BlogImage/raw/master/PythonSeries/Lesson21/21x7.png)

# 3.è¯»å–ç”¨æˆ·æµè§ˆå•†å“è®°å½•

```python
#è¯»å–ç”¨æˆ·æµè§ˆå•†å“è®°å½•
m_cols = ['Time', 'Action', 'User', 'Product']
views = pd.read_csv("purchase_view.tab", sep='\t', parse_dates={"Dates": [0]}, names=m_cols, encoding='utf-8')
print(views.info())
```

![](https://github.com/x-jeff/BlogImage/raw/master/PythonSeries/Lesson21/21x8.png)

```python
orders.groupby(['User', 'Product'])['Product'].count().head()
```

![](https://github.com/x-jeff/BlogImage/raw/master/PythonSeries/Lesson21/21x9.png)

```python
orders_cnt = orders.groupby(['User', 'Product'])['Product'].count().reset_index(name='buys')
print(orders_cnt.head())
```

![](https://github.com/x-jeff/BlogImage/raw/master/PythonSeries/Lesson21/21x10.png)

å¾—åˆ°çš„`orders_cnt`æ˜¯DataFrameæ ¼å¼ã€‚

ğŸ‘‰`reset_index`ç”¨äºé‡ç½®ç´¢å¼•ï¼š

```python
import pandas as pd
import numpy as np
df = pd.DataFrame(np.arange(20).reshape(5,4),index=[1,3,5,7,9])
print(df)
```

``` 
    0   1   2   3
1   0   1   2   3
3   4   5   6   7
5   8   9  10  11
7  12  13  14  15
9  16  17  18  19
```

```python
print(df.reset_index())
```

```
   index   0   1   2   3
0      1   0   1   2   3
1      3   4   5   6   7
2      5   8   9  10  11
3      7  12  13  14  15
4      9  16  17  18  19
```

ä¹Ÿå¯ä»¥ä¸ä¿ç•™indexåˆ—ï¼š

```python
print(df.reset_index(drop=True))
```

```
    0   1   2   3
0   0   1   2   3
1   4   5   6   7
2   8   9  10  11
3  12  13  14  15
4  16  17  18  19
```

ä¸€äº›å…¶å®ƒæƒ…å†µï¼š

```python
df[0].reset_index()
```

```
   index   0
0      1   0
1      3   4
2      5   8
3      7  12
4      9  16
```

```python
df[0].reset_index(name='A')
```

```
   index   A
0      1   0
1      3   4
2      5   8
3      7  12
4      9  16
```

```python
views_cnt = views.groupby(['User', 'Product'])['Product'].count().reset_index(name='views')
print(views_cnt.head())
```

![](https://github.com/x-jeff/BlogImage/raw/master/PythonSeries/Lesson21/21x11.png)

# 4.åˆå¹¶è´­ä¹°ä¸æµè§ˆè®°å½•

```python
#åˆå¹¶è´­ä¹°ä¸æµè§ˆè®°å½•
merge_df = pd.merge(orders_cnt, views_cnt, on=['User', 'Product'], how='right')
print(merge_df.head())
```

![](https://github.com/x-jeff/BlogImage/raw/master/PythonSeries/Lesson21/21x12.png)

## 4.1.`pandas.merge()`

```python
def merge(left, right, how='inner', on=None, left_on=None, right_on=None,
          left_index=False, right_index=False, sort=False,
          suffixes=('_x', '_y'), copy=True, indicator=False,
          validate=None)
```

éƒ¨åˆ†å‚æ•°è¯¦è§£ï¼š

1. `left`ï¼šå‚ä¸åˆå¹¶çš„å·¦ä¾§DataFrameã€‚
2. `right`ï¼šå‚ä¸åˆå¹¶çš„å³ä¾§DataFrameã€‚
3. `how`ï¼šâ€œinnerâ€ã€â€œouterâ€ã€â€œleftâ€ã€â€œrightâ€å…¶ä¸­ä¹‹ä¸€ã€‚é»˜è®¤ä¸ºâ€œinnerâ€ã€‚
4. `on`ï¼šç”¨äºè¿æ¥çš„åˆ—åã€‚å¿…é¡»å­˜åœ¨äºå·¦å³ä¸¤ä¸ªDataFrameå¯¹è±¡ä¸­ã€‚å¦‚æœæœªæŒ‡å®šï¼Œä¸”å…¶ä»–è¿æ¥é”®ä¹ŸæœªæŒ‡å®šï¼Œåˆ™ä»¥leftå’Œrightåˆ—åçš„äº¤é›†ä½œä¸ºè¿æ¥é”®ã€‚
5. `left_on`ï¼šå·¦ä¾§DataFrameä¸­ç”¨ä½œè¿æ¥é”®çš„åˆ—ã€‚
6. `right_on`ï¼šå³ä¾§DataFrameä¸­ç”¨ä½œè¿æ¥é”®çš„åˆ—ã€‚
7. `left_index`ï¼šå°†å·¦ä¾§çš„è¡Œç´¢å¼•ç”¨ä½œå…¶è¿æ¥é”®ã€‚
8. `right_index`ï¼šå°†å³ä¾§çš„è¡Œç´¢å¼•ç”¨ä½œå…¶è¿æ¥é”®ã€‚
9. `sort`ï¼šæ ¹æ®è¿æ¥é”®å¯¹åˆå¹¶åçš„æ•°æ®è¿›è¡Œæ’åºï¼Œé»˜è®¤ä¸ºTrueã€‚æœ‰æ—¶åœ¨å¤„ç†å¤§æ•°æ®é›†æ—¶ï¼Œç¦ç”¨è¯¥é€‰é¡¹å¯è·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚
10. `suffixes`ï¼šå­—ç¬¦ä¸²å€¼å…ƒç»„ï¼Œç”¨äºè¿½åŠ åˆ°é‡å åˆ—åçš„æœ«å°¾ï¼Œé»˜è®¤ä¸º`('_x','_y')`ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå·¦å³ä¸¤ä¸ªDataFrameå¯¹è±¡éƒ½æœ‰â€œdataâ€ï¼Œåˆ™ç»“æœä¸­å°±ä¼šå‡ºç°â€œdata\_xâ€å’Œâ€œdata\_yâ€ã€‚
11. `copy`ï¼šè®¾ç½®ä¸ºFalseï¼Œå¯ä»¥åœ¨æŸäº›ç‰¹æ®Šæƒ…å†µä¸‹é¿å…å°†æ•°æ®å¤åˆ¶åˆ°ç»“æœæ•°æ®ç»“æ„ä¸­ã€‚é»˜è®¤æ€»æ˜¯å¤åˆ¶ã€‚

ä¸‹é¢ä¸¾ä¾‹è¯´æ˜ä¸€ä¸‹ï¼Œå…ˆæ„å»ºä¸¤ä¸ªDataFrameï¼š

```python
df1=pd.DataFrame({'key':list('bbaca'),'data1':range(5)})
```

```
  key  data1
0   b      0
1   b      1
2   a      2
3   c      3
4   a      4
```

```python
df2=pd.DataFrame({'key':['a','b','c'],'data2':range(3)})
```

```
  key  data2
0   a      0
1   b      1
2   c      2
```

ğŸ‘‰`on`ï¼š

```python
pd.merge(df1,df2)
#ç­‰ä»·äº
pd.merge(df1,df2,on='key')
```

```
  key  data1  data2
0   b      0      1
1   b      1      1
2   a      2      0
3   a      4      0
4   c      3      2
```

ğŸ‘‰`left_on`å’Œ`right_on`ï¼š

é’ˆå¯¹ä¸¤è¾¹åˆå¹¶å­—æ®µä¸åŒæ—¶ã€‚

```python
df3=pd.DataFrame({'key1':list('bbaca'),'data1':range(5)})
df4=pd.DataFrame({'key2':['a','b','c'],'data2':range(3)})
pd.merge(df3,df4,left_on='key1',right_on='key2')
```

```
  key1  data1 key2  data2
0    b      0    b      1
1    b      1    b      1
2    a      2    a      0
3    a      4    a      0
4    c      3    c      2
```

ğŸ‘‰`how`ï¼š

é»˜è®¤ä¸ºâ€œinnerâ€ï¼Œå³å–äº¤é›†ã€‚â€œouterâ€ä¸ºå–å¹¶é›†ï¼Œå¹¶ä¸”ä¼šç”¨NaNå¡«å……ã€‚

```python
df5=pd.DataFrame({'key':list('bbacad'),'data1':range(6)})
pd.merge(df5,df2,how='outer')
```

```
  key  data1  data2
0   b      0    1.0
1   b      1    1.0
2   a      2    0.0
3   a      4    0.0
4   c      3    2.0
5   d      5    NaN
```

â€œleftâ€æ˜¯å·¦ä¾§DataFrameå–å…¨éƒ¨æ•°æ®ï¼Œå³ä¾§DataFrameåŒ¹é…å·¦ä¾§DataFrameï¼ˆå³è¿æ¥rightå’Œå·¦è¿æ¥ç±»ä¼¼ï¼‰ã€‚

```python
pd.merge(df5,df2,how='right')
```

```
  key  data1  data2
0   b      0      1
1   b      1      1
2   a      2      0
3   a      4      0
4   c      3      2
```

```python
pd.merge(df5,df2,how='left')
```

```
  key  data1  data2
0   b      0    1.0
1   b      1    1.0
2   a      2    0.0
3   c      3    2.0
4   a      4    0.0
5   d      5    NaN
```

ğŸ‘‰`left_index`å’Œ`right_index`ï¼š

å¯ä»¥é€šè¿‡è®¾ç½®`left_index`æˆ–è€…`right_index`çš„å€¼ä¸ºTrueæ¥ä½¿ç”¨ç´¢å¼•è¿æ¥ã€‚

```python
#è¿™é‡Œdf1ä½¿ç”¨data1å½“è¿æ¥å…³é”®å­—ï¼Œè€Œdf2ä½¿ç”¨ç´¢å¼•å½“è¿æ¥å…³é”®å­—
pd.merge(df1,df2,left_on='data1',right_index=True)
```

```
  key_x  data1 key_y  data2
0     b      0     a      0
1     b      1     b      1
2     a      2     c      2
```

ğŸ‘‰`suffixes`ï¼š

ä»ä¸Šé¢å¯ä»¥å‘ç°ä¸¤ä¸ªDataFrameä¸­éƒ½æœ‰keyåˆ—ï¼Œmergeåˆå¹¶ä¹‹åï¼Œpandasä¼šè‡ªåŠ¨åœ¨åé¢åŠ ä¸Š`(_x,_y)`æ¥åŒºåˆ†ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½®`suffixes`æ¥è®¾ç½®åå­—ã€‚

```python
pd.merge(df1,df2,left_on='data1',right_index=True,suffixes=('_df1','_df2'))
```

```
  key_df1  data1 key_df2  data2
0       b      0       a      0
1       b      1       b      1
2       a      2       c      2
```

## 4.2.äº†è§£ä½¿ç”¨è€…åœ¨ä¸åŒæ—¥æœŸä¸æ—¶é—´çš„æ¶ˆè´¹ä¹ æƒ¯

```python
views["Dates"].dt.date.head()
```

![](https://github.com/x-jeff/BlogImage/raw/master/PythonSeries/Lesson21/21x13.png)

>pandas.Series.dt.dateå®˜æ–¹ç”¨æ³•è¯´æ˜ï¼š[é“¾æ¥](https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Series.dt.date.html)ã€‚

```python
#ç»Ÿè®¡ç”¨æˆ·åœ¨ä¸åŒæ—¥æœŸçš„è®¿é—®æ¬¡æ•°
views_cnt_by_date = views.groupby(views["Dates"].dt.date)['Action'].count()
print(views_cnt_by_date.head())
```

![](https://github.com/x-jeff/BlogImage/raw/master/PythonSeries/Lesson21/21x14.png)

# 5.ç»˜åˆ¶å›¾è¡¨

>ç›¸å…³è®²è§£ï¼š[ã€PythonåŸºç¡€ã€‘ç¬¬äºŒåè¯¾ï¼šä½¿ç”¨pandasç»˜åˆ¶ç»Ÿè®¡å›¾è¡¨](http://shichaoxin.com/2021/05/14/PythonåŸºç¡€-ç¬¬äºŒåè¯¾-ä½¿ç”¨pandasç»˜åˆ¶ç»Ÿè®¡å›¾è¡¨/)ã€‚

```python
views_cnt_by_date.plot(kind="line", figsize=[10, 5])
```

![](https://github.com/x-jeff/BlogImage/raw/master/PythonSeries/Lesson21/21x15.png)

```python
views_cnt_by_hour = views.groupby(views["Dates"].dt.hour)['Action'].count()
views_cnt_by_hour.plot(kind="line", title="view count by hour", figsize=[10, 5])
```

![](https://github.com/x-jeff/BlogImage/raw/master/PythonSeries/Lesson21/21x16.png)

```python
g = orders.groupby('User')['Total_Price'].sum().sort_values(ascending=False)[0:10]
g.plot(kind='bar', figsize=[10, 5])
```

![](https://github.com/x-jeff/BlogImage/raw/master/PythonSeries/Lesson21/21x17.png)

```python
view_daily_cnt = views.groupby(views["Dates"].dt.date)["Action"].count()
orders_daily_cnt = orders.groupby(orders["Dates"].dt.date)["Action"].count()
df = pd.concat([view_daily_cnt, orders_daily_cnt], axis=1)
df.dropna(inplace=True)
df.plot(kind="line", figsize=[10, 5], rot=30)
```

![](https://github.com/x-jeff/BlogImage/raw/master/PythonSeries/Lesson21/21x18.png)

>pandas.concatå®˜æ–¹ç”¨æ³•è¯´æ˜ï¼š[é“¾æ¥](https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.concat.html?highlight=concat#pandas.concat)ã€‚
>
>`dropna`ç”¨æ³•ï¼š[é“¾æ¥](http://shichaoxin.com/2020/02/23/PythonåŸºç¡€-ç¬¬åä¸€è¯¾-å¤„ç†ç¼ºå¤±å€¼/#21èˆå¼ƒç¼ºå¤±å€¼)ã€‚

`plot`ä¸­çš„å‚æ•°`rot`æŒ‡çš„æ˜¯xè½´æ ‡ç­¾ï¼ˆè½´åˆ»åº¦ï¼‰çš„æ˜¾ç¤ºæ—‹è½¬åº¦æ•°ã€‚

# 6.ä»£ç åœ°å€

1. [ç½‘é¡µæµè§ˆè®°å½•èµ„æ–™åˆ†æ](https://github.com/x-jeff/Python_Code_Demo/tree/master/Demo21)

# 7.å‚è€ƒèµ„æ–™

1. [pandasä¸­çš„reset_index()](https://www.cnblogs.com/keye/p/11229863.html)
2. [[Python3]pandas.mergeç”¨æ³•è¯¦è§£](https://blog.csdn.net/Asher117/article/details/84725199)